<!-- templates/student_register.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Student Registration</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        video, canvas {
            border: 1px solid #ccc;
            margin-top: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <h2 class="mb-4 text-center">üéì Student Registration</h2>

    <form method="POST" class="row g-3">
        <div class="col-md-6">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-control" name="name" required>
        </div>

        <div class="col-md-6">
            <label class="form-label">Department</label>
            <select class="form-select" name="department" required>
                <option value="">Select Department</option>
                {% for dept in departments %}
                    <option value="{{ dept[1] }}">{{ dept[1] }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-6">
            <label class="form-label">Student ID</label>
            <input type="text" class="form-control" name="student_id" required>
        </div>

        <div class="col-md-6">
            <label class="form-label">Roll Number</label>
            <input type="text" class="form-control" name="roll_no" required>
        </div>

        <div class="col-md-6">
            <label class="form-label">Email ID</label>
            <input type="email" class="form-control" name="email" required>
        </div>

        <div class="col-md-6">
            <label class="form-label">Year</label>
            <select name="year" class="form-select" required>
                <option value="">Select Year</option>
                <option value="First">First Year</option>
                <option value="Second">Second Year</option>
                <option value="Third">Third Year</option>
                <option value="Fourth">Fourth Year</option>
            </select>
        </div>

        <input type="hidden" name="face_image" id="face_image">

        <div class="col-12 text-center">
            <video id="video" width="320" height="240" autoplay muted></video><br>
            <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
            <button type="button" id="captureBtn" class="btn btn-primary mt-2">üì∑ Capture Face</button>
        </div>

        <div class="col-12 text-center">
            <button type="submit" class="btn btn-success">‚úÖ Register</button>
            <a href="/" class="btn btn-secondary ms-2">üè† Return Home</a>
        </div>
    </form>
</div>

<script>
    const captureBtn = document.getElementById('captureBtn');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const faceImage = document.getElementById('face_image');

    window.onload = async () => {
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('/static/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('/static/models')
        ]);

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => video.srcObject = stream)
            .catch(err => alert("‚ùå Webcam access denied: " + err.message));
    };

    captureBtn.onclick = async () => {
        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions());

        if (!detection) {
            alert("‚ùå No face detected. Please try again.");
            return;
        }

        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        faceImage.value = canvas.toDataURL('image/jpeg');
        alert("‚úÖ Face captured! Now submit the form.");
    };
</script>
</body>
</html>
