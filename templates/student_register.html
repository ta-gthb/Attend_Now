<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Student Registration ‚Äî WebAuthn</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
body { background:#f8f9fa; }
.card { max-width:720px; margin:40px auto; padding:20px; }
.small-muted { font-size:0.9rem; color:#666; }
</style>
</head>
<body>
<div class="card shadow-sm">
<h3 class="mb-3">üéì Student Registration</h3>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}



<p class="small-muted">
Register your student account and secure it with a WebAuthn device (e.g., security key, fingerprint, or face recognition).
</p>


<form id="registerForm" method="POST" action="/student/register" class="row g-3">
<div class="col-md-6">
<label class="form-label">Full Name</label>
<input name="name" class="form-control" required />
</div>


<div class="col-md-6">
<label class="form-label">Department</label>
<select name="department" class="form-select" required>
<option value="">Select Department</option>
{% for dept in departments %}
<option value="{{ dept[1] }}">{{ dept[1] }}</option>
{% endfor %}
</select>
</div>


<div class="col-md-6">
<label class="form-label">Student ID</label>
<input name="student_id" class="form-control" required />
</div>


<div class="col-md-6">
<label class="form-label">Roll Number</label>
<input name="roll_no" class="form-control" required />
</div>


<div class="col-md-6">
<label class="form-label">Email</label>
<input type="email" name="email" class="form-control" required />
</div>


<div class="col-md-6">
<label class="form-label">Year</label>
<select name="year" class="form-select" required>
<option value="">Select Year</option>
<option value="First">First Year</option>
<option value="Second">Second Year</option>
<option value="Third">Third Year</option>
<option value="Fourth">Fourth Year</option>
</select>
</div>


<!-- Hidden fields for WebAuthn attestation or PIN fallback -->
<input type="hidden" name="webauthn_attestation" id="webauthn_attestation">


<div class="col-12">
<div id="webauthn-status" class="mb-2 small-muted">Checking WebAuthn availability...</div>
<div class="d-flex gap-2">
<button id="createCredentialBtn" type="button" class="btn btn-primary">üîê Register Device</button>
</div>
</div>

<div class="col-12 mt-3">
    <hr>
    <button type="submit" class="btn btn-success w-100">Complete Registration</button>
</div>
</form>
</div>

<script>
    // A few helpers for base64 conversions
    const bufferDecode = (value) => {
        const base64 = value.replace(/-/g, '+').replace(/_/g, '/');
        const padLength = (4 - (base64.length % 4)) % 4;
        const padded = base64.padEnd(base64.length + padLength, '=');
        const raw = atob(padded);
        return Uint8Array.from(raw, (c) => c.charCodeAt(0));
    };

    const bufferEncode = (value) =>
        btoa(String.fromCharCode.apply(null, new Uint8Array(value)))
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=/g, "");

    // DOM Elements
    const statusEl = document.getElementById('webauthn-status');
    const studentIdInput = document.querySelector('input[name="student_id"]');
    const nameInput = document.querySelector('input[name="name"]');
    const createCredentialBtn = document.getElementById('createCredentialBtn');
    const registerForm = document.getElementById('registerForm');
    const attestationInput = document.getElementById('webauthn_attestation');

    // Check for WebAuthn availability
    if (window.PublicKeyCredential) {
        statusEl.textContent = '‚úÖ WebAuthn is available on this browser.';
        createCredentialBtn.disabled = false;
    } else {
        statusEl.textContent = '‚ùå WebAuthn is not available on this browser. You cannot register.';
        createCredentialBtn.disabled = true;
    }

    // Final form submission logic
    registerForm.addEventListener('submit', (e) => {
        // Ensure WebAuthn is provided
        if (!attestationInput.value) {
            e.preventDefault();
            alert('Please register a device with WebAuthn before completing the registration.');
        }
    });

    // Handle WebAuthn credential creation
    createCredentialBtn.addEventListener('click', async () => {
        const studentId = studentIdInput.value;
        const name = nameInput.value;

        if (!studentId || !name) {
            alert('Please fill in your Name and Student ID first.');
            return;
        }

        // 1. Get options from the server
        const resp = await fetch('/student/register/options', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `student_id=${encodeURIComponent(studentId)}&name=${encodeURIComponent(name)}`
        });

        let options;
        try {
            options = await resp.json();
        } catch (e) {
            alert('Failed to get registration options from server.');
            return;
        }

        // 2. Turn challenge and user ID into buffers
        options.challenge = bufferDecode(options.challenge);
        options.user.id = bufferDecode(options.user.id);

        // 3. Call navigator.credentials.create()
        let credential;
        try {
            credential = await navigator.credentials.create({ publicKey: options });
        } catch (e) {
            alert('Registration failed or was cancelled.');
            console.error(e);
            return;
        }

        // 4. Encode the credential to a JSON-friendly format
        const attestation = {
            id: credential.id,
            rawId: bufferEncode(credential.rawId),
            response: {
                clientDataJSON: bufferEncode(credential.response.clientDataJSON),
                attestationObject: bufferEncode(credential.response.attestationObject),
            },
            type: credential.type,
        };

        // 5. Populate the hidden field and update UI
        attestationInput.value = JSON.stringify(attestation);
        statusEl.textContent = '‚úÖ Device registered! You can now complete the registration.';
        createCredentialBtn.classList.remove('btn-primary');
        createCredentialBtn.classList.add('btn-success');
        createCredentialBtn.textContent = '‚úì Device Registered';
    });
</script>
</body>
</html>
